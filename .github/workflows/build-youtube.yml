name: Build YouTube ReVanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Check daily at midnight UTC

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.new_patch }}
      cli_version: ${{ steps.versions.outputs.cli_version }}
      patch_version: ${{ steps.versions.outputs.patch_version }}
      patch_notes: ${{ steps.versions.outputs.patch_notes }}
    
    steps:
      - name: Check for patch updates
        id: check
        run: |
          # Get date from a GitHub release
          get_date() {
            local repo=$1 release_type=$2 pattern=$3
            json=$(wget -qO- "https://api.github.com/repos/$repo/releases")
            
            case "$release_type" in
              latest)
                updated_at=$(echo "$json" | jq -r 'first(.[] | select(.prerelease == false) | .assets[] | select(.name | test("'"$pattern"'")) | .updated_at)')
                ;;
              prerelease)
                updated_at=$(echo "$json" | jq -r 'first(.[] | select(.prerelease == true) | .assets[] | select(.name | test("'"$pattern"'")) | .updated_at)')
                ;;
              all)
                updated_at=$(echo "$json" | jq -r 'first(.[] | .assets[] | select(.name | test("'"$pattern"'")) | .updated_at)')
                ;;
              *)
                updated_at=$(echo "$json" | jq -r 'first(.[] | select(.tag_name == "'"$release_type"'") | .assets[] | select(.name | test("'"$pattern"'")) | .updated_at)')
                ;;
            esac
            echo "$updated_at"
          }
          
          # Check if new patches are available
          checker() {
            local repo=$1 release_type=$2 check_pattern=$3
            local date1 date2 date1_sec date2_sec
            
            # Get ReVanced patch update date
            date1=$(get_date "$repo" "$release_type" "^(.*\\.jar|.*\\.rvp)$")
            
            # Get your repository's last release date
            date2=$(get_date "${{ github.repository }}" "all" "$check_pattern")
            
            if [ -z "$date1" ]; then
              echo "::error::Failed to get ReVanced release date"
              echo "new_patch=0" >> $GITHUB_OUTPUT
              return
            fi
            
            date1_sec=$(date -d "$date1" +%s)
            
            # If no previous releases or new patch is available
            if [ -z "$date2" ]; then
              echo "new_patch=1" >> $GITHUB_OUTPUT
              echo "::notice::No previous builds found, building..."
            else
              date2_sec=$(date -d "$date2" +%s)
              
              if [ "$date1_sec" -gt "$date2_sec" ]; then
                echo "new_patch=1" >> $GITHUB_OUTPUT
                echo "::notice::New patch detected (ReVanced: $date1, Last build: $date2), building..."
              else
                echo "new_patch=0" >> $GITHUB_OUTPUT
                echo "::notice::No new patches (ReVanced: $date1, Last build: $date2), skipping build."
              fi
            fi
          }
          
          # Check for updates in revanced-patches
          checker "revanced/revanced-patches" "latest" "youtube-revanced.*\\.apk"

      - name: Get version information
        id: versions
        if: steps.check.outputs.new_patch == '1' || github.event_name == 'workflow_dispatch'
        run: |
          # Get CLI version
          CLI_RELEASE=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest)
          CLI_VERSION=$(echo "$CLI_RELEASE" | jq -r '.tag_name')
          echo "cli_version=$CLI_VERSION" >> $GITHUB_OUTPUT
          
          # Get Patches version and notes
          PATCH_RELEASE=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest)
          PATCH_VERSION=$(echo "$PATCH_RELEASE" | jq -r '.tag_name')
          PATCH_NOTES=$(echo "$PATCH_RELEASE" | jq -r '.body')
          
          echo "patch_version=$PATCH_VERSION" >> $GITHUB_OUTPUT
          
          # Store patch notes (multiline safe)
          {
            echo "patch_notes<<EOF"
            echo "$PATCH_NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  build:
    needs: check-updates
    if: needs.check-updates.outputs.should_build == '1' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup dependencies
        run: |
          mkdir -p ./release ./download ./src
          
          # Download pup for HTML parsing
          wget -q -O ./pup.zip https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
          unzip -q ./pup.zip -d ./
          chmod +x ./pup
          
          # Download APKEditor for merging splits
          wget -q -O ./APKEditor.jar https://github.com/REAndroid/APKEditor/releases/download/V1.4.2/APKEditor-1.4.2.jar

      - name: Download ReVanced tools
        run: |
          # Download latest ReVanced CLI and Patches
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          
          echo "ReVanced tools downloaded"

      - name: Download and Patch YouTube
        run: |
          # Color functions
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          # Request function with proper headers
          req() {
            if [ "$2" = "-" ]; then
              wget -nv -O "$2" \
                --header="User-Agent: Mozilla/5.0 (Android 14; Mobile; rv:134.0) Gecko/134.0 Firefox/134.0" \
                --header="Content-Type: application/octet-stream" \
                --header="Accept-Language: en-US,en;q=0.9" \
                --header="Connection: keep-alive" \
                --header="Upgrade-Insecure-Requests: 1" \
                --header="Cache-Control: max-age=0" \
                --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
                --keep-session-cookies \
                --timeout=30 \
                "$1" 2>&1 || rm -f "$2"
            else
              wget -nv -O "./download/$2" \
                --header="User-Agent: Mozilla/5.0 (Android 14; Mobile; rv:134.0) Gecko/134.0 Firefox/134.0" \
                --header="Content-Type: application/octet-stream" \
                --header="Accept-Language: en-US,en;q=0.9" \
                --header="Connection: keep-alive" \
                --header="Upgrade-Insecure-Requests: 1" \
                --header="Cache-Control: max-age=0" \
                --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
                --keep-session-cookies \
                --timeout=30 \
                "$1" 2>&1 || rm -f "./download/$2"
            fi
          }
          
          # APKMirror download function
          dl_apk() {
            local url=$1 regexp=$2 output=$3 bundle_type=$4
            
            if [[ -z "$bundle_type" ]] || [[ $bundle_type == "Bundle" ]] || [[ $bundle_type == "Bundle_extract" ]]; then
              url="https://www.apkmirror.com$(req "$url" - | tr '\n' ' ' | sed -n "s/.*<a[^>]*href=\"\([^\"]*\)\".*${regexp}.*/\1/p")"
            fi
            
            green_log "[+] APK page: $url"
            url="https://www.apkmirror.com$(req "$url" - | grep -oP 'class="[^"]*downloadButton[^"]*".*?href="\K[^"]+')"
            
            green_log "[+] Download button: $url"
            url="https://www.apkmirror.com$(req "$url" - | grep -oP 'id="download-link".*?href="\K[^"]+')"
            
            green_log "[+] Final download: $url"
            
            if [[ "$url" == "https://www.apkmirror.com" ]]; then
              red_log "[-] Download URL is empty"
              return 1
            fi
            
            req "$url" "$output"
          }
          
          green_log "[+] Detecting compatible YouTube version..."

          version=""
          attempt=0
          
          # Try ReVanced CLI compatible versions
          version=$(java -jar *cli*.jar list-patches --with-packages --with-versions *.rvp | \
            awk -v pkg="com.google.android.youtube" '
              BEGIN { found = 0 }
              /^Index:/ { found = 0 }
              /Package name:/ { if ($3 == pkg) found = 1 }
              /Compatible versions:/ {
                if (found) {
                  getline
                  latest = $1
                  while (getline && $1 ~ /^[0-9]+\./) latest = $1
                  print latest
                  exit
                }
              }')
          
          # Retry loop (APKMirror fallback)
          while [ $attempt -lt 10 ]; do
            if [[ -z "$version" || $attempt -ne 0 ]]; then
              version=$(req "https://www.apkmirror.com/uploads/?appcategory=youtube" - | \
                ./pup 'div.widget_appmanager_recentpostswidget h5 a.fontBlack text{}' | \
                grep -Evi 'alpha|beta' | \
                grep -oPi '\b\d+(\.\d+)+\b' | \
                sed -n "$((attempt + 1))p")
            fi
          
            if [[ -z "$version" ]]; then
              ((attempt++))
              continue
            fi
          
            version_dash=$(echo "$version" | sed 's/\./-/g')
            green_log "[+] Trying YouTube version: $version"
          
            if dl_apk "https://www.apkmirror.com/apk/google-inc/youtube/youtube-${version_dash}-release/" \
                      'BUNDLE<\/span>' \
                      "youtube.apkm" \
                      "Bundle_extract"; then
              break
            fi
          
            red_log "[-] Failed to download $version, trying older version"
            rm -f ./download/youtube.apkm
            unset version
            ((attempt++))
          done
          
          if [[ ! -f "./download/youtube.apkm" ]]; then
            red_log "[-] Failed to download a compatible YouTube version"
            exit 1
          fi
          
          green_log "[+] Selected YouTube version: $version"
          
          # Save version for release notes
          echo "YOUTUBE_VERSION=$version" >> $GITHUB_ENV
          
          # Extract bundle
          green_log "[+] Extracting APK bundle..."
          unzip -q "./download/youtube.apkm" -d "./download/youtube"
          
          if [[ ! -f "./download/youtube/base.apk" ]]; then
            red_log "[-] base.apk not found after extraction"
            ls -la ./download/youtube/
            exit 1
          fi
          
          green_log "[+] Successfully extracted bundle"
          ls -la ./download/youtube/
          echo ""
          green_log "[+] Available split configurations:"
          ls -1 ./download/youtube/*.apk | grep -v base.apk | sort
          echo ""
          green_log "[+] Total APK files in bundle: $(ls -1 ./download/youtube/*.apk | wc -l)"

      - name: Build Universal APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating universal APK..."
          java -jar ./APKEditor.jar m -i ./download/youtube -o ./download/youtube.apk
          
          if [[ ! -f ./download/youtube.apk ]]; then
            red_log "[-] Failed to create universal APK"
            exit 1
          fi
          
          green_log "[+] Patching universal APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-universal.apk \
            --purge=true \
            --force \
            ./download/youtube.apk
          
          if [[ -f ./release/youtube-revanced-universal.apk ]]; then
            green_log "[+] Successfully created universal APK"
            ls -lh ./release/youtube-revanced-universal.apk
          else
            red_log "[-] Failed to create universal APK"
          fi

      - name: Build arm64-v8a APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating arm64-v8a APK..."
          
          mkdir -p ./download/youtube-arm64-v8a
          cp ./download/youtube/base.apk ./download/youtube-arm64-v8a/
          
          EXCLUDE_ARCHS="armeabi_v7a x86 x86_64"
          
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            should_exclude=false
            for arch in $EXCLUDE_ARCHS; do
              if [[ "$basename_no_ext" == "split_config.$arch" ]]; then
                should_exclude=true
                break
              fi
            done
            
            if [ "$should_exclude" = false ]; then
              cp -f "$file" ./download/youtube-arm64-v8a/
            fi
          done
          
          green_log "[+] Files included in arm64-v8a build:"
          ls -la ./download/youtube-arm64-v8a/
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-arm64-v8a -o ./download/youtube-arm64-v8a.apk
          
          if [[ ! -f ./download/youtube-arm64-v8a.apk ]]; then
            red_log "[-] Failed to create arm64-v8a APK"
            exit 1
          fi
          
          green_log "[+] Patching arm64-v8a APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-arm64-v8a.apk \
            --purge=true \
            --force \
            ./download/youtube-arm64-v8a.apk
          
          if [[ -f ./release/youtube-revanced-arm64-v8a.apk ]]; then
            green_log "[+] Successfully created arm64-v8a APK"
          else
            red_log "[-] Failed to create arm64-v8a APK"
          fi

      - name: Build armeabi-v7a APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating armeabi-v7a APK..."
          
          mkdir -p ./download/youtube-armeabi-v7a
          cp ./download/youtube/base.apk ./download/youtube-armeabi-v7a/
          
          EXCLUDE_ARCHS="arm64_v8a x86 x86_64"
          
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            should_exclude=false
            for arch in $EXCLUDE_ARCHS; do
              if [[ "$basename_no_ext" == "split_config.$arch" ]]; then
                should_exclude=true
                break
              fi
            done
            
            if [ "$should_exclude" = false ]; then
              cp -f "$file" ./download/youtube-armeabi-v7a/
            fi
          done
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-armeabi-v7a -o ./download/youtube-armeabi-v7a.apk
          
          if [[ ! -f ./download/youtube-armeabi-v7a.apk ]]; then
            red_log "[-] Failed to create armeabi-v7a APK"
            exit 1
          fi
          
          green_log "[+] Patching armeabi-v7a APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-armeabi-v7a.apk \
            --purge=true \
            --force \
            ./download/youtube-armeabi-v7a.apk
          
          if [[ -f ./release/youtube-revanced-armeabi-v7a.apk ]]; then
            green_log "[+] Successfully created armeabi-v7a APK"
          else
            red_log "[-] Failed to create armeabi-v7a APK"
          fi

      - name: Build x86_64 APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating x86_64 APK..."
          
          mkdir -p ./download/youtube-x86_64
          cp ./download/youtube/base.apk ./download/youtube-x86_64/
          
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            if [[ "$basename_no_ext" =~ (arm64_v8a|armeabi_v7a) ]] && [[ ! "$basename_no_ext" =~ x86_64 ]]; then
              continue
            fi
            
            if [[ "$basename_no_ext" == "split_config.x86" ]]; then
              continue
            fi
            
            cp -f "$file" ./download/youtube-x86_64/
          done
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-x86_64 -o ./download/youtube-x86_64.apk
          
          if [[ ! -f ./download/youtube-x86_64.apk ]]; then
            red_log "[-] Failed to create x86_64 APK"
            exit 1
          fi
          
          green_log "[+] Patching x86_64 APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-x86_64.apk \
            --purge=true \
            --force \
            ./download/youtube-x86_64.apk
          
          if [[ -f ./release/youtube-revanced-x86_64.apk ]]; then
            green_log "[+] Successfully created x86_64 APK"
          else
            red_log "[-] Failed to create x86_64 APK"
          fi

      - name: Build x86 APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating x86 APK..."
          
          mkdir -p ./download/youtube-x86
          cp ./download/youtube/base.apk ./download/youtube-x86/
          
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            if [[ "$basename_no_ext" =~ (arm64_v8a|armeabi_v7a|x86_64) ]]; then
              continue
            fi
            
            cp -f "$file" ./download/youtube-x86/
          done
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-x86 -o ./download/youtube-x86.apk
          
          if [[ ! -f ./download/youtube-x86.apk ]]; then
            red_log "[-] Failed to create x86 APK"
            exit 1
          fi
          
          green_log "[+] Patching x86 APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-x86.apk \
            --purge=true \
            --force \
            ./download/youtube-x86.apk
          
          if [[ -f ./release/youtube-revanced-x86.apk ]]; then
            green_log "[+] Successfully created x86 APK"
          else
            red_log "[-] Failed to create x86 APK"
          fi

      - name: List built APKs
        run: |
          echo "Built APKs:"
          ls -lh ./release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-revanced-apks
          path: ./release/*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: YouTube ReVanced Build ${{ github.run_number }}
          files: ./release/*.apk
          body: |
            ## YouTube ReVanced Build
            
            **Built on:** ${{ github.event.repository.updated_at }}
            **YouTube version:** ${{ env.YOUTUBE_VERSION }}
            **ReVanced CLI:** ${{ needs.check-updates.outputs.cli_version }}
            **ReVanced Patches:** ${{ needs.check-updates.outputs.patch_version }}
            
            ---
            
            ## What's new in this release
            
            ${{ needs.check-updates.outputs.patch_notes }}
            
            ---
            
            ### Available APKs:
            - `youtube-revanced-universal.apk` - Works on all devices (larger size)
            - `youtube-revanced-arm64-v8a.apk` - For modern 64-bit ARM devices (recommended)
            - `youtube-revanced-armeabi-v7a.apk` - For older 32-bit ARM devices
            - `youtube-revanced-x86_64.apk` - For x86 64-bit devices
            - `youtube-revanced-x86.apk` - For x86 32-bit devices
            
            ### Installation:
            1. Uninstall official YouTube app if installed
            2. Download the appropriate APK for your device
            3. Install the APK (enable "Install from unknown sources")
            4. Sign in and enjoy!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
