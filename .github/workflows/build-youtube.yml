name: Build YouTube ReVanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup dependencies
        run: |
          mkdir -p ./release ./download
          
          # Download pup for HTML parsing
          wget -q -O ./pup.zip https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
          unzip -q ./pup.zip -d ./
          chmod +x ./pup
          
          # Download APKEditor for merging splits
          wget -q -O ./APKEditor.jar https://github.com/REAndroid/APKEditor/releases/download/V1.4.2/APKEditor-1.4.2.jar

      - name: Download ReVanced tools
        run: |
          # Download latest ReVanced CLI and Patches
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')

      - name: Get YouTube APK
        run: |
          # Get compatible version from patches
          VERSION=$(java -jar revanced-cli-*.jar list-patches --with-packages --with-versions *.rvp | \
            awk '/Package name: com.google.android.youtube/{found=1} found && /Compatible versions:/{getline; print $1; exit}')
          
          echo "Downloading YouTube version: $VERSION"
          
          # Convert version format for APKMirror
          VERSION_DASH=$(echo $VERSION | sed 's/\./-/g')
          
          # Download base APK bundle from APKMirror
          URL="https://www.apkmirror.com/apk/google-inc/youtube/youtube-${VERSION_DASH}-release/"
          DOWNLOAD_URL=$(wget -qO- "$URL" | grep -oP 'BUNDLE</span>.*?href="\K[^"]+' | head -1)
          DOWNLOAD_URL="https://www.apkmirror.com${DOWNLOAD_URL}"
          
          DOWNLOAD_URL=$(wget -qO- "$DOWNLOAD_URL" | grep -oP 'class="downloadButton.*?href="\K[^"]+')
          DOWNLOAD_URL="https://www.apkmirror.com${DOWNLOAD_URL}"
          
          FINAL_URL=$(wget -qO- "$DOWNLOAD_URL" | grep -oP 'id="download-link".*?href="\K[^"]+')
          FINAL_URL="https://www.apkmirror.com${FINAL_URL}"
          
          wget -O ./download/youtube.apkm "$FINAL_URL"
          
          # Extract bundle
          unzip -q ./download/youtube.apkm -d ./download/youtube

      - name: Patch YouTube (Universal)
        run: |
          # Merge all splits into universal APK
          java -jar ./APKEditor.jar m -i ./download/youtube -o ./download/youtube.apk
          
          # Patch
          java -jar revanced-cli-*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-universal.apk \
            --keystore=./src/ks.keystore \
            --purge=true \
            ./download/youtube.apk

      - name: Patch YouTube (arm64-v8a)
        run: |
          # Create architecture-specific build
          mkdir -p ./download/youtube-arm64
          cp ./download/youtube/base.apk ./download/youtube-arm64/
          cp ./download/youtube/split_config.arm64_v8a.apk ./download/youtube-arm64/ 2>/dev/null || true
          cp ./download/youtube/split_config.en.apk ./download/youtube-arm64/ 2>/dev/null || true
          
          java -jar ./APKEditor.jar m -i ./download/youtube-arm64 -o ./download/youtube-arm64.apk
          
          java -jar revanced-cli-*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-arm64-v8a.apk \
            --keystore=./src/ks.keystore \
            --purge=true \
            ./download/youtube-arm64.apk

      - name: Patch YouTube (armeabi-v7a)
        run: |
          mkdir -p ./download/youtube-arm32
          cp ./download/youtube/base.apk ./download/youtube-arm32/
          cp ./download/youtube/split_config.armeabi_v7a.apk ./download/youtube-arm32/ 2>/dev/null || true
          cp ./download/youtube/split_config.en.apk ./download/youtube-arm32/ 2>/dev/null || true
          
          java -jar ./APKEditor.jar m -i ./download/youtube-arm32 -o ./download/youtube-arm32.apk
          
          java -jar revanced-cli-*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-armeabi-v7a.apk \
            --keystore=./src/ks.keystore \
            --purge=true \
            ./download/youtube-arm32.apk

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-revanced-apks
          path: ./release/*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch'
        with:
          tag_name: v${{ github.run_number }}
          name: YouTube ReVanced Build ${{ github.run_number }}
          files: ./release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
