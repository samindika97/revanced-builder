name: Build YouTube ReVanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup dependencies
        run: |
          mkdir -p ./release ./download ./src
          
          # Download pup for HTML parsing
          wget -q -O ./pup.zip https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
          unzip -q ./pup.zip -d ./
          chmod +x ./pup
          
          # Download APKEditor for merging splits
          wget -q -O ./APKEditor.jar https://github.com/REAndroid/APKEditor/releases/download/V1.4.2/APKEditor-1.4.2.jar

      - name: Download ReVanced tools
        run: |
          # Download latest ReVanced CLI and Patches
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          wget -q $(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          
          # Create keystore - ReVanced CLI will auto-generate if not present
          # Or let CLI handle signing automatically
          echo "ReVanced tools downloaded"

      - name: Download and Patch YouTube
        run: |
          # Color functions
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          # Request function with proper headers
          req() {
            if [ "$2" = "-" ]; then
              wget -nv -O "$2" \
                --header="User-Agent: Mozilla/5.0 (Android 14; Mobile; rv:134.0) Gecko/134.0 Firefox/134.0" \
                --header="Content-Type: application/octet-stream" \
                --header="Accept-Language: en-US,en;q=0.9" \
                --header="Connection: keep-alive" \
                --header="Upgrade-Insecure-Requests: 1" \
                --header="Cache-Control: max-age=0" \
                --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
                --keep-session-cookies \
                --timeout=30 \
                "$1" 2>&1 || rm -f "$2"
            else
              wget -nv -O "./download/$2" \
                --header="User-Agent: Mozilla/5.0 (Android 14; Mobile; rv:134.0) Gecko/134.0 Firefox/134.0" \
                --header="Content-Type: application/octet-stream" \
                --header="Accept-Language: en-US,en;q=0.9" \
                --header="Connection: keep-alive" \
                --header="Upgrade-Insecure-Requests: 1" \
                --header="Cache-Control: max-age=0" \
                --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
                --keep-session-cookies \
                --timeout=30 \
                "$1" 2>&1 || rm -f "./download/$2"
            fi
          }
          
          # APKMirror download function
          dl_apk() {
            local url=$1 regexp=$2 output=$3 bundle_type=$4
            
            if [[ -z "$bundle_type" ]] || [[ $bundle_type == "Bundle" ]] || [[ $bundle_type == "Bundle_extract" ]]; then
              url="https://www.apkmirror.com$(req "$url" - | tr '\n' ' ' | sed -n "s/.*<a[^>]*href=\"\([^\"]*\)\".*${regexp}.*/\1/p")"
            fi
            
            green_log "[+] APK page: $url"
            url="https://www.apkmirror.com$(req "$url" - | grep -oP 'class="[^"]*downloadButton[^"]*".*?href="\K[^"]+')"
            
            green_log "[+] Download button: $url"
            url="https://www.apkmirror.com$(req "$url" - | grep -oP 'id="download-link".*?href="\K[^"]+')"
            
            green_log "[+] Final download: $url"
            
            if [[ "$url" == "https://www.apkmirror.com" ]]; then
              red_log "[-] Download URL is empty"
              return 1
            fi
            
            req "$url" "$output"
          }
          
          # Get compatible version
          green_log "[+] Detecting compatible YouTube version..."
          version=$(java -jar *cli*.jar list-patches --with-packages --with-versions *.rvp | \
            awk '/Package name: com.google.android.youtube/{found=1} found && /Compatible versions:/{getline; print $1; exit}')
          
          if [ -z "$version" ]; then
            red_log "[-] Could not detect version, using default"
            version="19.34.42"
          fi
          
          green_log "[+] YouTube version: $version"
          
          # Convert version to dash format
          version_dash=$(echo "$version" | tr -d ' ' | sed 's/\./-/g')
          
          # Download YouTube APK
          green_log "[+] Downloading YouTube $version..."
          url_regexp='BUNDLE<\/span>'
          
          if ! dl_apk "https://www.apkmirror.com/apk/google-inc/youtube/youtube-${version_dash}-release/" \
                      "$url_regexp" \
                      "youtube.apkm" \
                      "Bundle_extract"; then
            red_log "[-] Failed to download YouTube APK"
            exit 1
          fi
          
          if [[ ! -f "./download/youtube.apkm" ]]; then
            red_log "[-] YouTube APK not found after download"
            exit 1
          fi
          
          green_log "[+] Successfully downloaded YouTube APK"
          ls -lh ./download/youtube.apkm
          
          # Extract bundle
          green_log "[+] Extracting APK bundle..."
          unzip -q "./download/youtube.apkm" -d "./download/youtube"
          
          if [[ ! -f "./download/youtube/base.apk" ]]; then
            red_log "[-] base.apk not found after extraction"
            ls -la ./download/youtube/
            exit 1
          fi
          
          green_log "[+] Successfully extracted bundle"
          ls -la ./download/youtube/
          echo ""
          green_log "[+] Available split configurations:"
          ls -1 ./download/youtube/*.apk | grep -v base.apk | sort
          echo ""
          green_log "[+] Total APK files in bundle: $(ls -1 ./download/youtube/*.apk | wc -l)"

      - name: Build Universal APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating universal APK..."
          java -jar ./APKEditor.jar m -i ./download/youtube -o ./download/youtube.apk
          
          if [[ ! -f ./download/youtube.apk ]]; then
            red_log "[-] Failed to create universal APK"
            exit 1
          fi
          
          green_log "[+] Patching universal APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-universal.apk \
            --purge=true \
            --force \
            ./download/youtube.apk
          
          if [[ -f ./release/youtube-revanced-universal.apk ]]; then
            green_log "[+] Successfully created universal APK"
            ls -lh ./release/youtube-revanced-universal.apk
          else
            red_log "[-] Failed to create universal APK"
          fi

      - name: Build arm64-v8a APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating arm64-v8a APK..."
          
          # Use split_editor logic with EXCLUDE approach
          mkdir -p ./download/youtube-arm64-v8a
          
          # Copy base.apk
          cp ./download/youtube/base.apk ./download/youtube-arm64-v8a/
          
          # Define architectures to EXCLUDE (keep arm64-v8a)
          EXCLUDE_ARCHS="armeabi_v7a x86 x86_64"
          
          # Copy all splits except excluded architectures
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            # Skip base.apk (already copied)
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            # Check if this file should be excluded
            should_exclude=false
            for arch in $EXCLUDE_ARCHS; do
              if [[ "$basename_no_ext" == "split_config.$arch" ]]; then
                should_exclude=true
                break
              fi
            done
            
            # If not excluded, copy it
            if [ "$should_exclude" = false ]; then
              cp -f "$file" ./download/youtube-arm64-v8a/
            fi
          done
          
          green_log "[+] Files included in arm64-v8a build:"
          ls -la ./download/youtube-arm64-v8a/
          echo ""
          green_log "[+] Total files: $(ls -1 ./download/youtube-arm64-v8a/ | wc -l)"
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-arm64-v8a -o ./download/youtube-arm64-v8a.apk
          
          if [[ ! -f ./download/youtube-arm64-v8a.apk ]]; then
            red_log "[-] Failed to create arm64-v8a APK"
            exit 1
          fi
          
          green_log "[+] Merged APK size: $(du -h ./download/youtube-arm64-v8a.apk | cut -f1)"
          
          green_log "[+] Patching arm64-v8a APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-arm64-v8a.apk \
            --purge=true \
            --force \
            ./download/youtube-arm64-v8a.apk
          
          if [[ -f ./release/youtube-revanced-arm64-v8a.apk ]]; then
            green_log "[+] Successfully created arm64-v8a APK"
            green_log "[+] Final APK size: $(du -h ./release/youtube-revanced-arm64-v8a.apk | cut -f1)"
          else
            red_log "[-] Failed to create arm64-v8a APK"
          fi

      - name: Build armeabi-v7a APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating armeabi-v7a APK..."
          
          mkdir -p ./download/youtube-armeabi-v7a
          
          # Copy base.apk
          cp ./download/youtube/base.apk ./download/youtube-armeabi-v7a/
          
          # Define architectures to EXCLUDE (keep armeabi-v7a)
          EXCLUDE_ARCHS="arm64_v8a x86 x86_64"
          
          # Copy all splits except excluded architectures
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            # Skip base.apk (already copied)
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            # Check if this file should be excluded
            should_exclude=false
            for arch in $EXCLUDE_ARCHS; do
              if [[ "$basename_no_ext" == "split_config.$arch" ]]; then
                should_exclude=true
                break
              fi
            done
            
            # If not excluded, copy it
            if [ "$should_exclude" = false ]; then
              cp -f "$file" ./download/youtube-armeabi-v7a/
            fi
          done
          
          green_log "[+] Files included in armeabi-v7a build:"
          ls -la ./download/youtube-armeabi-v7a/
          echo ""
          green_log "[+] Total files: $(ls -1 ./download/youtube-armeabi-v7a/ | wc -l)"
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-armeabi-v7a -o ./download/youtube-armeabi-v7a.apk
          
          if [[ ! -f ./download/youtube-armeabi-v7a.apk ]]; then
            red_log "[-] Failed to create armeabi-v7a APK"
            exit 1
          fi
          
          green_log "[+] Merged APK size: $(du -h ./download/youtube-armeabi-v7a.apk | cut -f1)"
          
          green_log "[+] Patching armeabi-v7a APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-armeabi-v7a.apk \
            --purge=true \
            --force \
            ./download/youtube-armeabi-v7a.apk
          
          if [[ -f ./release/youtube-revanced-armeabi-v7a.apk ]]; then
            green_log "[+] Successfully created armeabi-v7a APK"
            green_log "[+] Final APK size: $(du -h ./release/youtube-revanced-armeabi-v7a.apk | cut -f1)"
          else
            red_log "[-] Failed to create armeabi-v7a APK"
          fi

      - name: Build x86_64 APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating x86_64 APK..."
          
          mkdir -p ./download/youtube-x86_64
          
          # Copy base.apk
          cp ./download/youtube/base.apk ./download/youtube-x86_64/
          
          # Copy only x86_64 and exclude other architectures
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            # Skip base.apk (already copied)
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            # Exclude other architectures
            if [[ "$basename_no_ext" =~ (arm64_v8a|armeabi_v7a) ]] && [[ ! "$basename_no_ext" =~ x86_64 ]]; then
              continue
            fi
            
            # Skip x86 (without _64)
            if [[ "$basename_no_ext" == "split_config.x86" ]]; then
              continue
            fi
            
            # Copy everything else (x86_64, language, dpi configs)
            cp -f "$file" ./download/youtube-x86_64/
          done
          
          green_log "[+] Files included in x86_64 build:"
          ls -la ./download/youtube-x86_64/
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-x86_64 -o ./download/youtube-x86_64.apk
          
          if [[ ! -f ./download/youtube-x86_64.apk ]]; then
            red_log "[-] Failed to create x86_64 APK"
            exit 1
          fi
          
          green_log "[+] Patching x86_64 APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-x86_64.apk \
            --purge=true \
            --force \
            ./download/youtube-x86_64.apk
          
          if [[ -f ./release/youtube-revanced-x86_64.apk ]]; then
            green_log "[+] Successfully created x86_64 APK"
            ls -lh ./release/youtube-revanced-x86_64.apk
          else
            red_log "[-] Failed to create x86_64 APK"
          fi

      - name: Build x86 APK
        run: |
          green_log() { echo -e "\e[32m$1\e[0m"; }
          red_log() { echo -e "\e[31m$1\e[0m"; }
          
          green_log "[+] Creating x86 APK..."
          
          mkdir -p ./download/youtube-x86
          
          # Copy base.apk
          cp ./download/youtube/base.apk ./download/youtube-x86/
          
          # Copy only x86 and exclude other architectures
          for file in ./download/youtube/*.apk; do
            filename=$(basename "$file")
            basename_no_ext="${filename%.apk}"
            
            # Skip base.apk (already copied)
            if [[ "$filename" == "base.apk" ]]; then
              continue
            fi
            
            # Exclude other architectures
            if [[ "$basename_no_ext" =~ (arm64_v8a|armeabi_v7a|x86_64) ]]; then
              continue
            fi
            
            # Copy everything else (x86, language, dpi configs)
            cp -f "$file" ./download/youtube-x86/
          done
          
          green_log "[+] Files included in x86 build:"
          ls -la ./download/youtube-x86/
          
          green_log "[+] Merging splits..."
          java -jar ./APKEditor.jar m -i ./download/youtube-x86 -o ./download/youtube-x86.apk
          
          if [[ ! -f ./download/youtube-x86.apk ]]; then
            red_log "[-] Failed to create x86 APK"
            exit 1
          fi
          
          green_log "[+] Patching x86 APK..."
          java -jar *cli*.jar patch \
            -p *.rvp \
            --out=./release/youtube-revanced-x86.apk \
            --purge=true \
            --force \
            ./download/youtube-x86.apk
          
          if [[ -f ./release/youtube-revanced-x86.apk ]]; then
            green_log "[+] Successfully created x86 APK"
            ls -lh ./release/youtube-revanced-x86.apk
          else
            red_log "[-] Failed to create x86 APK"
          fi

      - name: List built APKs
        run: |
          echo "Built APKs:"
          ls -lh ./release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-revanced-apks
          path: ./release/*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch'
        with:
          tag_name: v${{ github.run_number }}
          name: YouTube ReVanced Build ${{ github.run_number }}
          files: ./release/*.apk
          body: |
            ## YouTube ReVanced Build
            
            **Built on:** ${{ github.event.head_commit.timestamp }}
            
            ### Available APKs:
            - `youtube-revanced-universal.apk` - Works on all devices (larger size)
            - `youtube-revanced-arm64-v8a.apk` - For modern 64-bit ARM devices (recommended)
            - `youtube-revanced-armeabi-v7a.apk` - For older 32-bit ARM devices
            - `youtube-revanced-x86_64.apk` - For x86 64-bit devices
            - `youtube-revanced-x86.apk` - For x86 32-bit devices
            
            ### Installation:
            1. Uninstall official YouTube app if installed
            2. Download the appropriate APK for your device
            3. Install the APK (enable "Install from unknown sources")
            4. Sign in and enjoy!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
